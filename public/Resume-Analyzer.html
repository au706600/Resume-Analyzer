<!doctype html>
<html lang="en">
    <head>
        <title>Resume-Analyzer</title>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />

        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
        />

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>

        <style>
            
            .form-group
            {
                border-color: white;
                border-radius: 15px;
                background-color: wheat;
                border-style: solid;
                padding: 30px;
                width: 500px;
                margin: 20px;
                font-size: 15px;
                color: white;
            }
            

            .form-control
            {
                display: inline-block; 
            }

            #file
            {
                width: 400px;
            }

            .ai-field
            {
                width: 400px;
                height: 40px;
                border-radius: 10px;
                border-style: solid;
                border-color: rgb(43, 5, 72);
                padding: 10px;
                font-size: 16px;
            }

            .button1
            {
                background: linear-gradient(to right, #6ba8ff, #9d85f8);
                width: auto;
                color: #ffffff;
                border: none;
                padding: 14px 28px;
                font-size: 16px;
                font-weight: 500;
                width: 400px;
                border-radius: 10px;
            }
            
            .button1:focus {
                background: linear-gradient(to right, #6ba8ff, #9d85f8);
                color: #ffffff;
            }

            #Items
            {
                flex-direction: column;
                display: flex;
            }

            #output
            {
                max-width: 100%;
            }

            .result-container
            {
                font-size: 20px;
                border-radius: 10px;
                border-width: 5px;
                border-style: solid;
                border-color: rgb(43, 5, 72); 
                color: black;            
                padding: 30px;
                text-align: center;
                margin-top: 20px;
                width: 600px;
                height: 800px;
                position: relative;
                overflow: auto;
            }

            #arr-list
            {
                display: flex;
                flex-direction: column;
                list-style-type: none;
                padding: 0;
                margin: 0;
            }

            #arr-list > li
            {
                border-width: 5px;
                border-style: solid;
                border-color: rgb(43, 5, 72); 
                color: black; 
                border-radius: 10px;
                padding: 15px 20px;
                background-color: #f9f9f9;
                font-family: Arial, sans-serif;
                width: 700px;
            }

            .bullet-point
            {
                line-height: 2.0;
                font-family: Georgia, serif;
                list-style-type: disc;
                display: list-item;
            }

            .bullet-point::marker
            {
                color: black;
            }
            

            #inline-forms
            {
                display: flex;
                flex-direction: row;
                justify-content: flex-start;
                align-items: flex-start;
                gap: 50px;
                margin: 20px;
            }

            .left-column
            {
                display: flex;
                flex-direction: column;
                margin-left: 70px; 
            }

            .right-column
            {
                display: flex;
                flex-direction: column;
                margin-top: 40px;
                margin-left: 100px;
            }

            .canvas-wrapper
            {
                margin-top: 30px;
            }

            .headers
            {
                font-family: 'Poppins', sans-serif;
                font-size: 2.2rem;
                font-weight: 600;
                color: #2c2c2c;
                text-align: center;
                margin-top: 20px;
            }

            
            .hidden
            {
                display: none;
            }


        </style>
    </head> 

    <body>
        <header>
            <nav
                class="navbar navbar-expand-xl navbar-dark bg-dark"
            
            >
    
                <div class="collapse navbar-collapse justify-content-between" id="collapsibleNavId">
                    <ul class="navbar-nav mx-auto mt-2 mt-lg-0">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" aria-current="page"
                                >Home <span class="visually-hidden">(current)</span></a
                            >
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Link</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a
                                class="nav-link dropdown-toggle"
                                href="#"
                                id="dropdownId"
                                data-bs-toggle="dropdown"
                                aria-haspopup="true"
                                aria-expanded="false"
                                >Dropdown</a
                            >
                            <div class="dropdown-menu" aria-labelledby="dropdownId">
                                <a class="dropdown-item" href="#">Action 1</a>
                                <a class="dropdown-item" href="#">Action 2</a>
                            </div>
                        </li>
                    </ul>

                    <form class="d-flex my-2 my-lg-0">
                        <input
                            class="form-control me-sm-2"
                            type="text"
                            placeholder="Search"
                        />
                        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">
                            Search
                        </button>
                    </form>
                </div>
            </nav>
            
        </header>

        <main></main>

        <h1 class="headers">Optimize for Success - Get Feedback on your Resume</h1>

        <div id="inline-forms" class="container">
            <div class="left-column">
                <div class = "form-group">
                    <p style="color: black; font-weight: bold;" > Upload Resume</p>
                    <input style="width: 400px;" type="file" name="file" id="file" class="form-control" />
                    <br>
                    <br>
                    <br>
                    <p style="color: black; font-weight: bold;"> AI model</p>
                    <input type="text" value="deepseek-ai/DeepSeek-V3" class="ai-field" readonly/> 
                    <br>
                    <br>
                    <br>
                    <button class="button1" type="button">Upload & Analyze</button>
                </div>
    
                <div class="canvas-wrapper">
                    <canvas class = "result-container hidden" id="output"></canvas>
                </div>
            </div>

            <div class="right-column">
                <div id="Items">
                    <ul id="arr-list">
                    </ul>
                </div>
            </div>

        </div>

        <div style="display: flex; justify-content: center; margin: 20px;">
            <!--<textarea class="textarea" id="inline-form"></textarea> -->
            <div class="fa fa-refresh fa-spin hidden" style="top: 50%; left: 50%; position: fixed; font-size: 20px;"></div>
        </div>
    

        <!-- Bootstrap JavaScript Libraries -->
        <script
            src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"
        ></script>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
            integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
            crossorigin="anonymous"
        ></script>


        <script>
            // https://www.nutrient.io/blog/how-to-build-a-javascript-pdf-viewer-with-pdfjs/
            // https://stackoverflow.com/questions/74724367/how-to-add-items-as-children-of-an-unordered-list-using-javascript
            // https://codesignal.com/learn/courses/making-a-dynamic-todo-list-with-javascript/lessons/linking-javascript-to-dynamically-add-items

            //const text_area = document.querySelector('.textarea');

            // 

            function displayNestedList(map, parentElement)
            {
                const list = document.getElementById('arr-list');

                for(const [title, content] of Object.entries(map))
                {
                    const li = document.createElement('li');
                    const bulletUl = document.createElement('ul');
                    //const splitContent = content.split(/(?=\d+\.\s)/).map(point => point.trim()).filter(Boolean);
                    li.innerHTML = `<strong>${title}:</strong>`;
                    content.forEach((point) => {
                        const bulletLi = document.createElement('li');
                        bulletLi.textContent = point.replace(/^\d+\.\s*/, '');
                        bulletLi.classList.add('bullet-point');
                        bulletUl.appendChild(bulletLi);
                    });
                    li.appendChild(bulletUl);
                    list.appendChild(li);
                }
                
            }


            // Function to convert base64 string to ArrayBuffer, as arrayBuffer is needed for pdfjsLib
            function base64ToArrayBuffer(base64)
            {
                const binaryString = atob(base64); 
                const length = binaryString.length;
                const bytes = new Uint8Array(length); 

                for(let i = 0; i < length; i++)
                {
                    bytes[i] = binaryString.charCodeAt(i); 
                }

                return bytes.buffer; 
            }

            const result_container = document.getElementById('output');
            const ctx = result_container.getContext('2d');
            var pdfData = {
                zoom: 1, 
                currentPage: 1
            };

            document.querySelector('.button1').addEventListener('click', async () => {
                const fileInput = document.getElementById('file');
                var loadingScreen = document.querySelector('.fa.fa-refresh.fa-spin');

                if (!fileInput.files.length) {
                    alert('Please upload a PDF file.');
                    return;
                }
            
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                loadingScreen.classList.remove('hidden'); 
                try {
                    const response = await fetch('/', {
                        method: 'POST',
                        body: formData, 
                    });


                    console.log("Selected file", fileInput.files[0]);
            
                    const result = await response.json(); 
            
                    if (result.show_pdf) {
                        //const pdfjsLib = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.507/pdf.min.js');
                        //pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        //const retrieveDocument = pdfjsLib.getDocument(result.show_pdf);
                        
                        const arrayBuffer = base64ToArrayBuffer(result.show_pdf);
                        pdfjsLib.getDocument({data: arrayBuffer}).promise.then((pdfDoc) => {
                            return render(pdfDoc);
                        });

                        // Function to render the PDF page
                        function render(pdfDoc){
                            pdfDoc.getPage(pdfData.currentPage).then((page) => {
                                const viewport = page.getViewport({scale: pdfData.zoom});
                                result_container.width = viewport.width;
                                result_container.height = viewport.height;
                                result_container.classList.remove('hidden');
                                const render = {
                                    canvasContext: ctx, 
                                    viewport: viewport
                                };
                                return page.render(render).promise;
                            });
                        }
                    } else {
                        alert('Error Resume-analyzer. Please try again.'); 
                    }

                    //console.log("Is it array?", Array.isArray(result.displayAI));
                    //console.log("Display AI message:", result.displayAI);
                    //console.log("Display the content of AI message", result.displayAI[0]);

                    if(result.displayAI && typeof result.displayAI === 'object')
                    {
                        //List.innerHTML = `<p class="result-container">${result.displayAI}</p>`;
                        //const list = document.getElementById('arr-list');

                       
                       // for(const [title, content] of Object.entries(result.displayAI))
                       // {
                       //     const mainPoints = content.split(/\d+\.\s*/).filter(Boolean);
                       //     const li = document.createElement('li');
                       //     li.innerHTML = `<strong>${title}:</strong> ${content}`;
                       //     list.appendChild(li);
                       // }

                       displayNestedList(result.displayAI, document.getElementById('arr-list'));
                    }
                        

                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed. Ensure the server is running.');
                }

                finally {
                    loadingScreen.classList.add('hidden'); 
                }
            });
        </script> 
            
    </body>
</html>

